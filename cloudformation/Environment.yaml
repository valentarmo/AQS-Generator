Description: Deploy several EC2 instances
Parameters:
  KeyName:
    Description: Name of an existing EC2 KeyPair
    Type: String
  Region:
    Description: AWS Region
    Type: String
    AllowedValues: [us-east-1, us-west-1, us-east-2, us-west-2]
Mappings:
  RegionMap:
    us-east-1:
      AMI: ami-047a51fa27710816e
    us-west-1:
      AMI: ami-005c06c6de69aee84
    us-east-2:
      AMI: ami-01aab85a5e4a5a0fe
    us-west-2:
      AMI: ami-0e999cbd62129e3b1
Resources:
  CodeDeployRole:
    Type: 'AWS::IAM::Role'
    Properties:
      Description: Role for CodeDeploy
      ManagedPolicyArns: ['arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole']
      RoleName: AQSGeneratorsCodeDeployRole
      Path: '/'
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codedeploy.amazonaws.com
            Action:
              - "sts:AssumeRole"
  CodeDeployApplication:
    Type: 'AWS::CodeDeploy::Application'
    Properties:
      ApplicationName: AQSGenerators
      ComputePlatform: Server
  DeploymentGroup:
    Type: 'AWS::CodeDeploy::DeploymentGroup'
    Properties:
      ApplicationName: AQSGenerators
      DeploymentGroupName: AQSGeneratorsDeploymentGroup
      DeploymentConfigName: CodeDeployDefault.AllAtOnce
      Ec2TagFilters:
        - Key: AQSGenerator
          Type: KEY_ONLY
      ServiceRoleArn: !GetAtt CodeDeployRole.Arn
      DeploymentStyle:
        DeploymentOption: WITHOUT_TRAFFIC_CONTROL
        DeploymentType: IN_PLACE
  SSHSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Enable SSH access via port 22
      SecurityGroupIngress:
      - CidrIp: 0.0.0.0/0
        FromPort: 22
        IpProtocol: tcp
        ToPort: 22
  EC2Instance0:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap [RegionMap, !Ref Region, AMI]
      InstanceType: t2.micro
      SecurityGroups: [!Ref SSHSecurityGroup]
      Tags:
        - Key: AQSGenerator
          Value: yes 
  EC2Instance1:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap [RegionMap, !Ref Region, AMI]
      InstanceType: t2.micro
      SecurityGroups: [!Ref SSHSecurityGroup]
      Tags:
        - Key: AQSGenerator
          Value: yes
  EC2Instance2:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap [RegionMap, !Ref Region, AMI]
      InstanceType: t2.micro
      SecurityGroups: [!Ref SSHSecurityGroup]
      Tags:
        - Key: AQSGenerator
          Value: yes
  EC2Instance3:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap [RegionMap, !Ref Region, AMI]
      InstanceType: t2.micro
      SecurityGroups: [!Ref SSHSecurityGroup]
      Tags:
        - Key: AQSGenerator
          Value: yes
  EC2Instance4:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap [RegionMap, !Ref Region, AMI]
      InstanceType: t2.micro
      SecurityGroups: [!Ref SSHSecurityGroup]
      Tags:
        - Key: AQSGenerator
          Value: yes
  EC2Instance5:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap [RegionMap, !Ref Region, AMI]
      InstanceType: t2.micro
      SecurityGroups: [!Ref SSHSecurityGroup]
      Tags:
        - Key: AQSGenerator
          Value: yes
  EC2Instance6:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap [RegionMap, !Ref Region, AMI]
      InstanceType: t2.micro
      SecurityGroups: [!Ref SSHSecurityGroup]
      Tags:
        - Key: AQSGenerator
          Value: yes
  EC2Instance7:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap [RegionMap, !Ref Region, AMI]
      InstanceType: t2.micro
      SecurityGroups: [!Ref SSHSecurityGroup]
      Tags:
        - Key: AQSGenerator
          Value: yes
  EC2Instance8:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap [RegionMap, !Ref Region, AMI]
      InstanceType: t2.micro
      SecurityGroups: [!Ref SSHSecurityGroup]
      Tags:
        - Key: AQSGenerator
          Value: yes
  EC2Instance9:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap [RegionMap, !Ref Region, AMI]
      InstanceType: t2.micro
      SecurityGroups: [!Ref SSHSecurityGroup]
      Tags:
        - Key: AQSGenerator
          Value: yes
Outputs:
  PublicIP0:
    Value: !GetAtt EC2Instance0.PublicIp
    Description: Instance's public IP address
  PublicIP1:
    Value: !GetAtt EC2Instance1.PublicIp
    Description: Instance's public IP address
  PublicIP2:
    Value: !GetAtt EC2Instance2.PublicIp
    Description: Instance's public IP address
  PublicIP3:
    Value: !GetAtt EC2Instance3.PublicIp
    Description: Instance's public IP address
  PublicIP4:
    Value: !GetAtt EC2Instance4.PublicIp
    Description: Instance's public IP address
  PublicIP5:
    Value: !GetAtt EC2Instance5.PublicIp
    Description: Instance's public IP address
  PublicIP6:
    Value: !GetAtt EC2Instance6.PublicIp
    Description: Instance's public IP address
  PublicIP7:
    Value: !GetAtt EC2Instance7.PublicIp
    Description: Instance's public IP address
  PublicIP8:
    Value: !GetAtt EC2Instance8.PublicIp
    Description: Instance's public IP address
  PublicIP9:
    Value: !GetAtt EC2Instance9.PublicIp
    Description: Instance's public IP address